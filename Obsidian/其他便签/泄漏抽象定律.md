互联网工程中有一个关键的魔法，我们每天都依赖它。它存在于 TCP 协议中，它是互联网的基本组成部分之一。

_TCP 是一种可靠的_数据传输方式。我的意思是：如果您使用 TCP 通过网络发送消息，该消息将会到达，并且不会出现乱码或损坏。

TCP 可用于多种用途，例如获取网页和发送电子邮件。TCP 的可靠性是每封电子邮件都能完好无损地送达的原因。即使它只是一些愚蠢的垃圾邮件。

相比之下，还有另一种数据传输方法，称为 IP，但它并不_可靠_。没有人保证您的数据一定会到达，而且在到达之前可能会出现混乱。如果您使用 IP 发送大量消息，那么只有一半消息到达也不足为奇，而且其中一些消息的顺序与发送顺序不同，其中一些消息已被替换为替代消息，这些消息可能包含可爱的小猩猩图片，或者更可能只是一堆无法阅读的垃圾信息，看起来像您收到的外语垃圾邮件。

神奇的是：TCP 建立在 IP 之上。换句话说，TCP 必须以某种方式_使用不可靠的工具来_可靠地发送数据。

为了说明为什么这是魔法，请考虑以下现实世界中在道德上等同但有点荒谬的场景。

想象一下，我们有一种将演员从百老汇送到好莱坞的方法，就是把他们放在车里，开车带他们穿越全国。有些车撞坏了，可怜的演员们丧命。有时演员们在路上喝醉了，剃了头或在鼻子上刺青，因此太丑了，不适合在好莱坞工作，而且演员们到达的顺序经常与他们出发时的顺序不同，因为他们走的路线都不一样。现在想象一下一种名为“好莱坞快车”的新服务，它将演员送到好莱坞，保证他们 (a) 按顺序 (b) 到达 (c) 完好无损。神奇的是，好莱坞快车没有其他运送演员的方法，除了把他们放在车里，开车带他们穿越全国这种不可靠的方法。好莱坞快车的工作原理是检查每个演员是否完好无损地到达，如果没有，就打电话给总部，要求派演员的同卵双胞胎代替。如果演员到达的顺序不对，好莱坞快车会重新安排他们。如果一架大型 UFO 在前往 51 区的途中坠毁在内华达州的高速公路上，导致该路无法通行，所有前往该路段的演员都会改道经亚利桑那州，而好莱坞快车甚至不会告诉加利福尼亚州的电影导演发生了什么。对他们来说，演员们似乎只是比平时慢了一点到达，他们甚至从未_听说_过 UFO 坠毁的消息。

这大概就是 TCP 的魔力所在。计算机科学家喜欢称其为抽象_：_将幕后发生的复杂事情简化。事实证明，许多计算机编程都包含抽象的构建。什么是字符串库？这是一种假装计算机可以像操作数字一样轻松地操作字符串的方法。什么是文件系统？这是一种假装硬盘不是一堆可以在某些位置存储位的旋转磁盘，而是文件夹内的文件夹的分层系统，其中包含由一个或多个字节字符串组成的单个文件。

回到 TCP。之前为了简单起见，我说了个小谎，现在你们中的一些人已经气得耳朵都冒烟了，因为这个小谎快把你们逼疯了。我说 TCP 保证你的消息会到达。实际上，它不能。如果你养的蛇咬断了通向你电脑的网络电缆，_没有_IP 数据包可以通过，那么 TCP 就无能为力，你的消息就不会到达。如果你对公司的系统管理员很粗鲁，他们惩罚你，把你接入一个超载的集线器，只有一些 IP 数据包会通过，TCP 可以工作，但一切都会变得非常慢。

这就是我所说的“_泄漏抽象”_。TCP 试图提供底层不可靠网络的完整抽象，但有时，网络会通过抽象泄漏信息，您会感觉到抽象无法完全保护您免受其害。这只是我所说的“泄漏抽象定律”的一个例子：

|                           |
| ------------------------- |
| **所有非平凡的抽象在某种程度上都是有漏洞的。** |

抽象会失败。有时会失败一点，有时会失败很多。存在泄漏。事情出错了。当你有抽象时，这种情况随处可见。以下是一些示例。

- 像对大型二维数组进行迭代这样简单的事情，如果水平方向而不是垂直方向进行，性能可能会有很大差异，这取决于“纹理”——一个方向可能导致的页面错误比另一个方向多得多，而且页面错误很慢。即使是汇编程序员也可以假装他们有一个很大的平面地址空间，但虚拟内存意味着它实际上只是一个抽象概念，当出现页面错误时，它就会泄漏，并且某些内存提取所需的时间比其他内存提取要多得多。
- SQL 语言旨在抽象出查询数据库所需的过程步骤，而是允许您仅定义您想要的内容，然后让数据库找出查询的过程步骤。 但在某些情况下，某些 SQL 查询比其他逻辑上等效的查询慢数千倍。 一个著名的例子是，如果您指定“where a=b and b=c and a=c”，则某些 SQL 服务器的速度会比仅指定“where a=b and b=c”快得多，即使结果集相同。 您不必关心过程，只需关心规范。 但有时抽象会出现泄漏并导致可怕的性能，您必须打破查询计划分析器并研究它做错了什么，并找出如何让您的查询运行得更快。
- 尽管 NFS 和 SMB 等网络库允许您将远程计算机上的文件“当作”本地文件，但有时连接会变得非常慢或中断，并且文件不再像本地文件一样运行，作为程序员，您必须编写代码来处理这个问题。 “远程文件与本地文件相同”的抽象[存在泄漏](https://www.joelonsoftware.com/articles/fog0000000041.html)。以下是 Unix 系统管理员的一个具体示例。如果您将用户的主目录放在 NFS 挂载的驱动器上（一种抽象），并且您的用户创建 .forward 文件将所有电子邮件转发到其他地方（另一种抽象），而 NFS 服务器在有新电子邮件到达时发生故障，则消息将不会被转发，因为找不到 .forward 文件。抽象中的泄漏实际上导致一些消息被丢失。
- C++ 字符串类旨在让您假装字符串是一等数据。它们试图抽象出字符串[很难的](https://www.joelonsoftware.com/articles/fog0000000319.html)事实，让您认为它们和整数一样简单。几乎所有 C++ 字符串类都重载了 + 运算符，因此您可以编写**s + “bar”**来连接。但您知道吗？无论他们如何努力，地球上都没有 C++ 字符串类可以让您输入**“foo” + “bar”**，因为 C++ 中的字符串文字始终是 char*，而不是字符串。抽象产生了语言不允许您堵塞的漏洞。（有趣的是，C++ 随着时间的推移而发展的历史可以描述为试图堵塞字符串抽象漏洞的历史。为什么他们不能直接在语言本身中添加本机字符串类，我现在还不明白。）
- 下雨时你也不能开那么快，尽管你的车有雨刷、前灯、车顶和加热器，所有这些都使你不必担心下雨的事实（它们将天气抽象化），但你还是得担心水滑（或在英国称为滑水），而且有时雨太大，你无法看清很远的前方，所以你在雨中开得更慢，因为根据泄漏抽象定律，天气永远不可能完全抽象化。

泄漏抽象定律有问题的一个原因是，它意味着抽象并没有像预期的那样真正简化我们的生活。当我培训某人成为 C++ 程序员时，如果我永远不需要教他们有关 char* 和指针算法的知识，那就太好了。如果我可以直接讲 STL 字符串，那就太好了。但是有一天，他们会编写代码**“foo”+“bar”**，然后会发生真正奇怪的事情，然后我不得不停下来，教他们所有关于 char* 的知识。或者有一天，他们会尝试调用一个记录为具有 OUT LPTSTR 参数的 Windows API 函数，他们将无法理解如何调用它，直到他们了解了 char*、指针、Unicode、wchar_t、TCHAR 头文件和所有那些泄漏的东西。

在教别人 COM 编程时，如果我能教他们如何使用 Visual Studio 向导和所有代码生成功能就好了，但如果出现任何问题，他们根本不知道发生了什么，也不知道如何调试和恢复。我将不得不教他们有关 IUnknown、CLSID 和 ProgIDS 的所有知识……哦，人性！

在教某人 ASP.NET 编程时，如果我可以教他们双击某些东西，然后编写在用户单击这些东西时在服务器上运行的代码，那就太好了。事实上，ASP.NET 抽象出了编写 HTML 代码来处理单击超链接（**<a>**）和处理单击按钮的代码之间的区别。问题：ASP.NET 设计人员需要隐藏 HTML 中无法从超链接提交表单的事实。他们通过生成几行 JavaScript 并将 onclick 处理程序附加到超链接来实现这一点。但是抽象存在漏洞。如果最终用户禁用了 JavaScript，则 ASP.NET 应用程序无法正常工作，而如果程序员不理解 ASP.NET 抽象出了什么，他们根本不知道哪里出了问题。

泄漏抽象定律意味着，每当有人想出一种新的代码生成工具，声称可以让我们变得非常高效时，你就会听到很多人说“先学习如何手动操作，然后使用这种工具来节省时间。”假装抽象出某些东西的代码生成工具，就像所有抽象一样，都会泄漏，而有效处理泄漏的唯一方法是了解抽象的工作原理以及它们抽象的内容。因此，抽象节省了我们的工作时间，但并没有节省我们的学习时间。

而所有这些都意味着，矛盾的是，即使我们拥有越来越高级的编程工具和越来越好的抽象，成为一名熟练的程序员也变得越来越难。

在我第一次在微软实习期间，我编写了在 Macintosh 上运行的字符串库。一个典型的任务：编写一个**strcat**版本，返回指向新字符串末尾的指针。几行 C 代码。我所做的一切都来自 K&R——一本关于 C 编程语言的薄书。

今天，为了在 CityDesk 上工作，我需要了解 Visual Basic、COM、ATL、C++、InnoSetup、Internet Explorer 内部结构、正则表达式、DOM、HTML、CSS 和 XML。与旧的 K&R 相比，这些都是高级工具，但我仍然必须了解 K&R 的东西，否则我就完蛋了。

十年前，我们可能想象到新的编程范式会让编程变得更容易。事实上，多年来我们创建的抽象_确实_使我们能够处理软件开发中十年或十五年前不需要处理的新复杂程度，例如 GUI 编程和网络编程。虽然这些伟大的工具（如现代的 OO 基于表单的语言）让我们能够非常快速地完成大量工作，但突然有一天我们需要找出抽象泄漏的问题，这需要 2 周的时间。当你需要雇用一名程序员来做大部分 VB 编程时，仅仅雇用一名 VB 程序员是不够的，因为每次 VB 抽象泄漏时，他们都会完全陷入困境。

泄漏抽象定律正在拖累我们。