重构是改善代码的核心技术。关于重构的标准参考读物是Martin Fowler的著作《重构：改善 既有代码的使用》1。更多关于在有测试情况下的重构，我建议你去阅读Martin的大作。

本附录的意图是描述一个关键的重构手法：方法提取 (Extract Method)。从而给你一些关于 在有测试情况下的重构机制的认识。

**方法提取**
在所有的重构手法中，方法提取大约是最有用的一种了。方法提取手法背后的理念是我们可以系统地将一个大的方法分解为一些小的。这会令代码更易理解。此外我们常常还能在系统的其 他部分复用分解出来的代码块并避免逻辑重复。

**在维护得很糟糕的代码基中，方法会倾向于越“长”越大。人们会不断往既有代码中添加 逻辑，于是这些方法就会不断膨胀。并且，随着这一过程的发生， 一个方法便会最终承担起两 到三个不同的职责。极端情况下一个方法甚至会做十件乃至上百件事情。而方法提取正是这些 病症的解药。

**当想要提取一个方法时，首要的事情便是要有一组测试。如果你有一组测试能够完全覆盖目 标方法，则可以采用下述步骤对它进行方法提取：
(1)找出你想要提取出来的代码，将其注释掉。
(2)创建一个新的空方法，给它起一个名字。
(3)在原方法中调用这个新方法。
(4).将你想要提取的代码放到新方法中。
(5)依靠编译器(251页)帮你发现新方法要接受哪些参数以及返回什么值。
(6)相应调整新方法的声明，声明参数列表和返回类型。
(7)运行你的测试。
(8)删掉第一步注释掉的代码。

***
1.此书英文注释版即将由人民邮电出版社出版。另外，Joshua Kerievsky的《重构与模式》(人民邮电出版社)是重 构方面的另一部重要著作，体现了近年来重构领域的成就和发展，并充分阐述了重构与模式的深刻关系。

——编者注
***
下面是一个简单的Java例子：
![[Pasted image 20240524165826.png]]
以上代码中的else 语句负责计算premium 预定的手续费。考虑到系统中还有其他地方也需 要用到这块逻辑，所以我们可以将它提取到一个新方法中并在其他地方复用它。

下面是第一步：
![[Pasted image 20240524165939.png]]我们想要调用新方法getPremiumFee,    于是创建该方法并将对它的调用加到那个else   子句中：
![[Pasted image 20240524170002.png]]下一步，将else 子句中原来的代码复制到getPremiumFee() 中，编译：
![[Pasted image 20240524170024.png]]正如预料的那样，编译通不过。因为被复制到getPremiumFee() 中的代码使用了名为 result 和amount的两个变量，而这两个变量在getPremiumFee() 中并未声明。由于我们计算 的只是结果的一部分，所以可以直接返回计算的结果。此外， amount 变量可以通过为get-   PremiumFee() 增加一个相应的参数来获得：
![[Pasted image 20240524170042.png]]现在便可以运行测试来检验我们的成果了。如果代码通过测试，则就可以将原来注释掉的代 码完全删除了：
![[Pasted image 20240524170103.png]]

**我喜欢先将待提取的代码注释掉而不是直接删掉(你不一定要这么做),这样一来，如果 后面的步骤出了错的话就可以容易地还原原来的代码，并重新尝试。

上面的例子只是展示了方法提取的一种方式。在有测试的情况下，方法提取是一个相对简单和安全的操作。而如果你有重构工具的话那就更简单了——只需选择某函数中的一块代码，然后  选择一个菜单即可。工具会帮你检查那块代码能否被提取成一个新方法并让你输入新方法的名字。

方法提取是对付遗留代码的核心手段。你可以用它来提取重复代码、分离职责，以及分解长 方法。