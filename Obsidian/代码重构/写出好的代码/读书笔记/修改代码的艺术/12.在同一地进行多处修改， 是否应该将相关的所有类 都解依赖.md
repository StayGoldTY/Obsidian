有些情况下，要开始给一个类编写测试还是比较容易的。不过要是遗留代码的话往往就不那 么简单了。可能会遇到一些难以解开的依赖。在痛下决心将一批类弄进测试用具从而让以后的日 子好过些之后，最令人窝火的事情莫过于却又发现要进行一堆挤在一块儿的修改。你要把一个新 特性加进系统，同时发现为此得修改三四个紧密相关的类，其中每一个类都是不花上几个钟头就 没指望能放入测试之下的。你心里头当然清楚要是捏着鼻子干完这事儿的话代码肯定会变得容易 对付得多，然而，真的必须得一个一个的来解开所有这些依赖吗?那可不一定。

通常有一个办法值得一试，那就是所谓“退一层测试”,“退后一层”,从而找到一个地点能 够同时给多处修改编写测试。比如要对一系列私有方法进行修改，只需为某一个公有方法编写测 试就行了。或者，要对某个对象所持有的一组互相协作的对象进行测试，我们只需测试前者的接 口即可。采用这种方法不仅能够达到覆盖所作修改的目的，还能在代码重构方面提供更大的自由 度；在不违反测试所限定的行为的前提下，测试覆盖之下的代码无论怎么改都不要紧。

![](file:///C:\Users\TY\AppData\Local\Temp\ksohtml32088\wps78.png)

那么我们到底该如何才能将这些“覆盖测试”安置妥当呢?首先便是确定测试的地点。如果 还没有的话，建议你看一看第11章。该章描述了所谓的“影响结构图”,影响结构图是一个强大 的工具，可以用它来推断出测试地点。而本章则描述了拦截点 (interception   point) 的概念，并展 示了如何寻找到拦截点。此外还描述了在代码中所能找到的最佳拦截点，即所谓的汇点 (pinch  point) 。 我会告诉你如何寻找到这些点，以及当你想要编写测试来覆盖将要修改的代码时，寻找

  

到的这些点将会给你带来什么样的帮助。

**12.1** **拦截点**

给定一处修改，在程序中存在某些点能够探测到该修改的影响，我们把这些点称为拦截点。 寻找拦截点的难易程度跟具体的应用程序是有关系的。比如，假设一个应用程序中的各个部件都 搅和在一块，没多少自然接缝的话，在其中要想寻找到一个合适的拦截点就相当费工夫，不进行 一点影响分析以及解开大量的依赖是别想达到目的的。

最佳切入点莫过于先确定需要进行修改的点，并从这些修改点开始一路向外追踪影响。每个 可以探测影响的点都是一个拦截点，但并非每个都是最佳拦截点，在整个过程中你都需要自己进 行判断。

**12.1.1**  **简单的情形**

现在，假想我们需要修改一个名为Invoice   的Java类，目的是要更改该类计算费用的方式。

Invoice   类上面的那个计算总计费用的方法叫做getvalue,       如下所示：