**25.7** **提取并重写工厂方法**

在你试图将一个类纳入测试时，可能会发现构造函数中的对象创建令你头疼不已。有时候你并不想在测试的时候创建这些对象。还有些时候你或许只是想放置一个感知对象。然而现实是你没法做到这一点，因为这些对象的创建被固定在构造函数体中了。

**构造函数中固定了的初始化工作可能会给测试带来很大的麻烦。
![[Pasted image 20240524145432.png]]

WorkflowEngine    的构造函数中创建了一个TransactionManager。如果这个对象是在其他 地方被创建的话，我们便能更容易地引入分离。要实现这个条件，选择之一便是使用提取并重写 工厂方法 (Extract and Override Factory Method)。

**提取并重写工厂方法是个相当强大的手法，但它存在一些语言相关的问题。例如它在C++   里面是行不通的。C++ 并不允许在构造函数中的虚函数调用被决议到派生类中去。而Java及许多其他语言则允许这一点。那么在C++中怎么办呢?可以考虑用替换实例变量(317页)和提 取并重写获取方法(278页)来代替。关于这个问题替换实例变量—节有示例及讨论。

![[Pasted image 20240524145602.png]]
有了工厂方法之后，便可以将它子类化并重写了，我们可以在重写的工厂方法中返回我们想 要返回的东西：
![[Pasted image 20240524145629.png]]
**步** **骤
提取并重写工厂方法的步骤如下：
(1)找出构造函数中的新建对象处。
(2)将所有涉及新建该对象的代码通通转移到一个工厂方法中。
(3)创建一个测试子类，重写刚才的那个工厂方法以避免测试期间对问题类型的依赖。