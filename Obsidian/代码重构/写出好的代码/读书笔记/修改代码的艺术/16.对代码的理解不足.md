一般来说踏入陌生代码的领地(尤其是遗留代码)时心里难免会有点发毛。不过一段时间以后有些人也就对此相对免疫了。他们在代码中一次次披荆斩棘，建立起了对付这类情况的信心， 但要想临阵不惧还是挺难的。每个人难免都会遇到没法越过的鸿沟。如果在查看代码前就思前想 后，那么情况只会变得更糟。你永远都不知道一个修改是简单的，还是会让你一个星期都焦头烂额直到咀咒系统咀咒自己的遭遇咀咒周围一切事物。如果我们具备进行修改所需的一切知识的 话，事情应该会顺利许多。但怎么实现这一 点呢?

以下就是一种典型的情况：你首先发现一个想要加到系统中去的特性，然后开始浏览代码。 有时候的确能够在代码中得到所需的一切信息，但对于遗留代码来说，这可能会耗些时间。你在 头脑中列出需要做的各件事情，在不同方案之间来回权衡。然后某个瞬间，你可能觉得有了进展， 觉得有足够的信心可以开始了。又或者你也可能会被那一大堆需要实现的东西搞得头昏脑涨。阅 读代码似乎并没有给你带来多大的帮助，于是你开始就你所知道的去做，并在心里祈祷一切顺利。

然而事实上情况还可以变得更好。并非只有这么一种理解代码的途径，只不过许多人就是不 想去用其他办法，因为他们正忙着试图尽快把代码理解清楚。毕竞，把时间花在理解某某东西上  面感觉就好像不是在用心工作一样。要是可以迅速完成理解的过程，就可以接着投入“真正的” 工作了。这么想不对，但往往就是有人会这么干，这很让人感到惋惜，因为他们本可以只需花上  一 点点低技术含量的工夫就可以让自己后面的工作处于一个更坚固的基石上了。

**16.1**  **注记/草图**

如果阅读代码还是搞不清的话，你可以画草图并作一些注记。把最近看到的重要的地方写下 来。如果你看到它们之间存在着某个联系，就在它们之间画一条线。这些草图不一定要像UML  图或函数调用图那样复杂，以致于到处都是一些专用符号；不过要是事情本身真的变复杂了，则 你可以适当考虑把图画得正式、干净一点，这样有助于你理清思路。草图往往能够帮助我们从另 一个角度来看待问题。此外在我们试图理解一些特别复杂的东西的时候，草图对于记录我们的思 考状态也是极有帮助的。

图16- 1是我前几天跟另一个程序员在浏览代码的时候画的，我把它重新画在下面，当时我们 是画在一个备忘录的反面的(出于某些考虑，图里面涉及的名字被我改掉了)。
![[Pasted image 20240523114226.png]]目前这幅草图还不是那么容易理解，但对于我们当时进行的讨论和交流来说已经够了。我们 得到了一些认识，并最终建立了一个方案。

![](file:///C:\Users\TY\AppData\Local\Temp\ksohtml32088\wps87.png)你可能会问，难道我们每个人不都正是这么做的吗?其实，很少有人会常常这么做。而且我 怀疑原因在于没人告诉你这类事情到底该怎么做，人们很容易就会认为每次当他们把笔放到纸上 的时候都应该是写代码片段或是画UML 图 。UML 本身是没错，但圆圈和线条，还有那些不是在 场人就无法理解的各种形状的图形也是有用的。图只是工具，其目的是让交流变得容易，并帮助 我们记住所讨论的概念以及认识到的东西。

通过画草图来帮助理解一个设计的某部分的做法还有一个非常好的地方就是，它不拘一格且 富有感染力。如果该技术有用，则根本无需强迫你的团队去使用它，你所需做的就是，等到你去 协助某个希望理解某块代码的人的时候，在解释的时候通过画草图来帮助你解释代码的意思。如 果你的队友真的在认真搞清系统的那部分的话，他/她便会看着草图并跟着你的思路去理解代码。

当开始要给一个系统做局部草图的时候，通常你可能会想先花点时间来从整体上理解系统。 对此可参考第17章，里面有一组技术可以帮助你更容易地理解和照料大型代码基。

**16.2**  **清单标注**

要帮助理解代码，草图也并不是唯一的办法。比如一个我常用的方法就是“清单标注”。这 对非常长的方法尤其有用。其实它的思想也很简单，而且几乎每个人或多或少都这么做过，只不 过坦白地说，我认为人们没有能够把这个手法充分利用起来。

为一个代码清单作标注的方式取决于你到底想要理解什么。第一步是打印出你想要对付的代 码。之后，就可以使用代码清单标注的方式来帮助你完成下面的任何步骤了。

**16.2.1**  **职责分离**

如果你想要分离职责，则可以使用一个记号来把有关的代码分组。比如你看到某几段/行代 码是属于一起的，就可以在它们旁边都标上同一个特殊记号，这样你一眼就能认出来。另外，可能的话，使用多种颜色。

**16.2.2**  **理解方法结构**

如果想要理解一个很长的方法，考虑把代码块对齐。长方法中的缩进常常会使我们无法阅读 代码。这时你可以从代码块的开头到结尾画一条线，或者在每个代码块的结尾用注释标明它对应 着哪个条件语句或是循环，从而把代码块首尾呼应起来。

对齐代码块的最简单办法就是从内到外。例如，如果你的代码是用C语言家族的一员写的话， 你只要从代码开始一直往下读，越过每个左括号，直到遇到头一个右括号，把这个右括号标记一 下，然后回溯到与它匹配的那个左括号，标记它。然后接着刚才的右括号继续往下读，看到下一 个右括号之后，做同样的事情；往回走直到遇到跟它匹配的那个左括号。

**16.2.3**  **方** **法** **提** **取**

如果想要分解一个长方法，可以考虑把你想要提取出来的代码圈起来，并注上它的耦合数(见 第22章)。

**16.2.4**  **理解你的修改产生的影响**

如果想要弄清你准备进行的修改会产生哪些影响，除了使用影响结构图之外，还可以在你准 备修改的那行代码旁做上记号。然后在每一个可能被此行代码的改动所影响的变量和方法调用旁 做上记号。接下来再给每一个可能被你己经标记的东西的改动所影响的变量和方法做记号……尽 量多做几次直到你看清影响是如何从修改点传播开来的。通过这一过程，你就会对自己所需要测 试的东西有一个更好的认识。

**16.3**  **草稿式重构**

认识代码的最佳技术就是重构。你走进代码， 一番捣鼓之后，代码变得更清晰了。唯一的问 题就是，如果没有测试，这个过程可能会令人相当抓狂。在你为了理解代码而进行重构的整个过 程中，如何知道你的修改不会破坏已有的东西?其实你可以根本无需考虑这些，这很容易做到：
从代码控制系统中输出代码，别去管测试编写的事情，只管去提取方法、移动变量，以你喜欢的 方式去进行重构吧，但这么做了之后你可得记住别再把这些代码输入到服务器上去了。这种做法 叫做“草稿式重构”。

我第一次跟一个同事提起这事情的时候，他觉得那是浪费时间，但半个小时之后他的看法完 完全全改变了，因为我们在半个小时捣鼓代码的过程中极大地深化了对代码的认识。

草稿式重构可以极大地帮助你了解代码的本质以及认识代码是如何工作的，但使用的时候也并非没有一点风险。首先我们在重构的时候可能会犯一些恶劣的错误，从而使得我们误解代码的 行为。这种对系统的错误认识在后面当我们开始进行真正的重构的时候会给我们带来麻烦。第二 个风险也是与此相关的，那就是在第一次重构完代码之后，我们的思维可能就会固定在重构出来 的系统的样子上了。这听上去似乎不应该是件多么糟糕的事情，但也未必。在我们后面进行真正重构的时候，可能会出现各种各样的原因，导致系统最终呈现出来的结构并非我们草稿式重构出 来的那样。也就是说后面我们还可能会看到更好的调整代码结构的方式。我们的代码可能时不时 会被改动，自己也可能会不断产生新的想法。然而倘若我们的思维局限于草稿式重构所生成的代 码结构的话，后面可能就会错过许多很好的想法了。

想要相信自己已经理解了代码中最重要的方面，草稿式重构是个很好的途径，而且前者本身 也会令你的工作变得更容易。你会觉得相当自信，觉得那些边边角角的地方也并没有什么可怕的 东西，或者说，即便有，你也会提前注意到。

**16.4**  **删除不用的代码**

如果你正在看的代码让你感到迷惑，而且你敢断定这段代码中有些部分并没有被使用到，那 么就删掉它们吧。它们除了挡路之外没带来任何正面效应。

有些时候人们会觉得删除代码挺浪费的，毕竟编写它们的人曾在上面花了时间和精力。或许

![](file:///C:\Users\TY\AppData\Local\Temp\ksohtml32088\wps88.png)能在将来用得上呢?版本控制系统正是替你做这事情的，这段代码会被保留在先前的版本中。如 果后面你发现又要用到它了，总是可以到版本控制系统那儿获取到。