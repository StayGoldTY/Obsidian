**25.13** **连接替换**

面向对象方法学给了我们很多替换对象的契机。比如只要两个类实现了共同的接口，或具有共同的基类，那么我们便可以轻松地将其中一个的对象替换为另一个的对象。但遗憾的是，像C 这样的过程式语言的程序员没这个福气。比如下面这个函数，如果不用预处理手段，就完全没法 在编译期将其替换为另一个函数：

void     account_deposit(int     amount);

还有其他办法吗?有。可以使用连接替换(Link  Substitution)手法来将它替换为另一个函数。 实施该手法时，你创建一个哑元库，该库里面包含一个跟以上函数签名完全一样的函数。如果你  的目的是感知，那么需要在该函数里面设置一些机制来保存通知消息并对它们进行查找。可以使  用文件，全局变量，或其他办法，只要你觉得方便就行。
![[Pasted image 20240524160738.png]]从以上代码中可以看出，我们感兴趣的是感知，所以创建了一个全局列表，该列表里面包含 了每次该函数被调用时的有关信息。在测试时，我们可以在测试完一组对象之后检查该列表来确 认该函数是否按照正确的顺序被调用了。

我个人从未对C++类用过这一手法，但我想道理是一样的。当然，我相信C++ 编译器的名字 粉碎机制肯定会带来一些困难；但如果调用的是C 函数，则该手法是非常可行的。其最大的用处 就是用来伪造外部库内的函数。而最好伪造的又属那些纯数据汇'的库：对于这类库，你只是调 用其中的函数，而通常并不关心其返回值。图形库就是这样的一个例子。

连接替换手法也可以用在Java中。做法是创建一个同名同方法集的类，然后修改类路径，让 调用被决议到你的新类上，从而避开原类上的糟糕依赖。

**步** **骤
连接替换的步骤如下：
(1)找出你想要伪造的函数或类。
(2)为它们编写另一份定义。
(3)修改你的构建参数，让你的伪造品能够代替真品被连接到项目中。