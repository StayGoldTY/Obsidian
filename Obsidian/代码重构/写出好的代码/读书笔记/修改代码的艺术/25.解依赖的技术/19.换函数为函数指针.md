在过程式语言中解依赖可没有在面向对象语言中那么多选择。比如你没法使用封装全局引用 (268页)或是子类化并重写方法 (314页)。所有这些面向对象的解依赖手法都行不通。当然，你 还是可以使用连接替换(296页)或定义补全 (266页),但它们对于解开一些小的依赖又显得有 点杀鸡用牛刀了。对于支持函数指针的语言，换函数为函数指针 (Replace Function with Function Pointer) 手法是一个可选的方案。众所周知的支持函数指针的语言就属C了。

不同的团队对函数指针有着不同的看法。有些团队认为函数指针极度不安全，因为指针的内 容可能会被破坏，从而导致被调用的是一块随机内存。而有些团队则把它当成有用的工具，当然， 小心使用是前提。实际上，如果你站在后者的阵营，便可以借助于这一工具来解开用其他办法很 难或者无法解开的依赖。

首先让我们来看一看函数指针的自然用法。下面这个例子是C写的，其中我们声明了一些函 数指针并通过它们来发起调用：
![[Pasted image 20240524163258.png]]函数指针可以实现一些非常初级的基于对象的编程，然而在解依赖方面它们又有多大用处 呢?考虑下面这个场景。

有一个网络应用，包信息被保存在一个在线数据库中。你通过如下的调用来与该数据库 交互：
![[Pasted image 20240524163330.png]]我们可以使用连接替换(296页)来将这些函数连接到新的函数体，但连接替换有时会给构 建过程带来较大麻烦。比如我们可能会需要将问题函数从它所在的库中分离出来以便替换它们。 更重要的是，在产品代码中根本没法使用连接替换所获得的接缝来调节行为。如果你想要将代码 纳入测试同时又能提供产品实现的灵活性(比如切换你的代码所访问的数据库的类型)的话，换 函数为函数指针是个好主意。下面就是具体的步骤。

首先我们找出想要替换为函数指针的函数：
![[Pasted image 20240524163350.png]]现在便可以编译和测试了。

有了这个函数指针，测试文件便可以替换进，从而达到感知或分离的目的。

**换函数为函数指针手法是解依赖的好办法。它的好处之一便是发生在编译期(而非连接 期),因此对你的构建系统几乎没有影响。然而，如果你是在C里面运用这项技术的，那么请 考虑转移到C++, 以便利用C++提供的各种各样的接缝。在本书写作时，许多C编译器都提供 了编译开关来允许你进行C/C++混合编译。利用这个性能你便可以将C项目逐步往C++迁移， 每次只需对你关心的那些文件进行解依赖。

**步** **骤
换函数为函数指针手法的步骤如下：
(1)找到你想要替换的函数的声明。
(2)在每个找到的函数之前创建一个同名的函数指针。
(3)重命名原函数的声明，以避免跟刚才声明的函数指针重名。
(4)在一个C文件中初始化这些函数指针，将它们指向相应的函数。
 (5)构建，通过构建错误来找出原函数的函数体。将它们改为新的函数名。