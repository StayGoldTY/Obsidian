## 问题 1：单元测试做不好，是否会影响到 CI 的效果？
这是一个非常好的问题，问到了各种实践之间的关联。

我们在前面用了两讲的篇幅介绍了持续集成这个实践，为什么要做持续集成以及如何做好持续集成。

在自动化模块，我们还会在这个基础之上继续延伸，介绍持续交付，这些内容是从操作的层面上进行介绍，都是对单一实践的描述。

利用这次答疑的机会，我再补充一个维度，谈谈实践之间的关联。

持续集成的价值在于，它是一条主线，可以将诸多实践贯穿起来。

也就是说，想要真正意义上做好持续集成，需要把周边的很多实践都要做好。我们具体地说一下这些实践。但请记住我们说过的，**做好持续集成的关键是，快速反馈**。

比如，我们想要做好 CI，需要有一个稳定的开发分支，所以，最好采用主开发分支的方式。想用好主分支开发，最好能够频繁提交；
而频繁提交需要你的任务足够小，能够快速完成；
将任务拆解的足够小，需要你真正懂得任务分解。
要想在一个分支上开发多个功能，那就需要用 Feature Toggle 或者 Branch by Abstraction。

![[Pasted image 20240925165309.png]]

在这条线上，你有很多机会走错路。比如，

你选择了分支开发模式，合并速度就不会太快，一旦反馈快不了，CI 的作用就会降低；

再者，如果不能频繁提交，每次合并代码的周期就会变长，一旦合并代码的周期变长，人们就会倾向于少做麻烦事，也就会进一步降低提交的频率，恶性循环就此开启。

同样，即便你懂得了前面的道理，不懂任务分解，想频繁提交，也是心有余而力不足的。

而多功能并行开发，则会让你情不自禁地想考虑使用多分支模型。

我们再来看另外一条线，也就是这个问题中提到的测试。

想做好 CI，首先要有可检查的东西，什么是可检查的东西，最简单的就是编译、代码风格检查，这些检查可以无条件加入构建脚本。但更重要的检查，应该来自于测试，而要想做好 CI，我们要有测试防护网。

![[Pasted image 20240925165429.png]]
什么叫测试防护网呢？就是你的测试要能给你提供一个足够安全的保障，这也就意味着你要有足够多的测试。

换个更技术点的术语来说，就是要有足够高的测试覆盖率。如果测试覆盖率不够，即便提交了代码，CI 都通过了，你对自己的代码依然是没有信心的，这就会降低 CI 在你的心中的地位。

如果想有足够高的测试覆盖率，你就要多写单元测试。

我们在前面讲过测试金字塔了，上层测试因为很麻烦，你不会写太多，而且很多边界条件，通过上层测试是覆盖不到的，所以，测试覆盖率在经过了初期的快速提升后，到后期无论如何是提上不去的。

要想提升测试覆盖率，唯有多写单元测试。

要想多写单元测试，就需要编写可以测试的代码，而要想编写可测的代码，就要懂软件设计，将系统之间耦合解开。

通过上面的分析，你已经看出来做好持续集成，让它完全发挥自己的价值，需要做的工作还是相当多的。**但也请别灰心，实际上，我做咨询时，很多团队就是从持续集成下手，开始改造他们的软件开发过程。**

这是一个“以终为始”的思路，先锁定好目标，就是要把持续集成做好，然后围绕着这个目标改进其他做得欠佳的方面。

比如，原来是多分支的，就先固定一个主分支，然后，逐步改变大家的开发习惯，让他们进入单分支的开发状态。

再比如，原来没有测试，那就在 CI 上先加一个最低的测试覆盖率，然后定期去提高，比如，第一周是 10%，第二周是 20%，这样一步一步地提高，开发团队可以一边开发新东西，一边为既有代码补测试。

等到覆盖率到了一定程度，提高有困难了，团队就可以考虑怎么改进设计了。

所以，CI 作为一个单独的实践，本身是很简单的，但它可以成为提纲挈领的主线，帮助团队不断改善自己的开发过程。