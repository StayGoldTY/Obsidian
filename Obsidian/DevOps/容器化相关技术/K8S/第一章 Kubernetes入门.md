### 一、Kubernetes基本概述

![](https://pics2.baidu.com/feed/96dda144ad3459824290a532fdf229a3cbef8409.jpeg@f_auto?token=cd825f2943be53f3ffc9ef30a14a5ab3)

kubernetes，简称 K8s，是用 8 代替 8 个字符“ubernete”而成的缩写。是一个开源的，用于管理云平台中多个主机上的容器化的应用，Kubernetes 的目标是让部署容器化的应用简单并且高效（powerful）,Kubernetes 提供了应用部署，规划，更新，维护的一种机制。  
  
传统的应用部署方式是通过插件或脚本来安装应用。这样做的缺点是应用的运行、配置、管理、所有生存周期将与当前操作系统绑定，这样做并不利于应用的升级更新/回滚等 操作，当然也可以通过创建虚拟机的方式来实现某些功能，但是虚拟机非常重，并不利于可移植性。  
  
新的方式是通过部署容器方式实现，每个容器之间互相隔离，每个容器有自己的文件系统 ，容器之间进程不会相互影响，能区分计算资源。相对于虚拟机，容器能快速部署， 由于容器与底层设施、机器文件系统解耦的，所以它能在不同云、不同版本操作系统间进行迁移。  
  
容器占用资源少、部署快，每个应用可以被打包成一个容器镜像，每个应用与容器间 成一对一关系也使容器有更大优势，使用容器可以在 build 或 release 的阶段，为应用创建容器镜像，因为每个应用不需要与其余的应用堆栈组合，也不依赖于生产环境基础结构，这使得从研发到测试、生产能提供一致环境。类似地，容器比虚拟机轻量、更“透明”， 这更便于监控和管理。  
  
Kubernetes 是 Google 开源的一个容器编排引擎，它支持自动化部署、大规模可伸缩、应用容器化管理。在生产环境中部署一个应用程序时，通常要部署该应用的多个实例以便对应用请求进行负载均衡。  
  
在 Kubernetes 中，我们可以创建多个容器，每个容器里面运行一个应用实例，然后通过内置的负载均衡策略，实现对这一组应用实例的管理、发现、访问，而这些细节都不需要运维人员去进行复杂的手工配置和处理。  
  
# 总结：  
1、k8s是谷歌在2014年开业的容器化集群管理系统  
2、使用k8s进行容器化应用部署  
3、使用k8s利于应用扩展  
4、k8s目标实施让部署容器化应用更加简洁和高效

### 二、Kubernetes简介

Kubernetes 是一个可移植的、可扩展的开源平台，用于管理容器化的工作负载和服务，可促进声明式配置和自动化。Kubernetes 拥有一个庞大且快速增长的生态系统。Kubernetes 的服务、支持和工具广泛可用。  
  
Kubernetes是一个全新的基于容器技术的分布式领先方案。简称：K8S。它是Google开源的容器集群管理系统，它的设计灵感来自于Google内部的一个叫作Borg的容器管理系统。继承了Google十余年的容器集群使用经验。它为容器化的应用提供了部署运行、资源调度、服务发现和动态伸缩等一些列完整的功能，极大地提高了大规模容器集群管理的便捷性。  
  
kubernetes是一个完备的分布式系统支撑平台。具有完备的集群管理能力，多扩多层次的安全防护和准入机制、多租户应用支撑能力、透明的服务注册和发现机制、內建智能负载均衡器、强大的故障发现和自我修复能力、服务滚动升级和在线扩容能力、可扩展的资源自动调度机制以及多粒度的资源配额管理能力。  
  
在集群管理方面，Kubernetes将集群中的机器划分为一个Master节点和一群工作节点Node，其中，在Master节点运行着集群管理相关的一组进程kube-apiserver、kube-controller-manager和kube-scheduler，这些进程实现了整个集群的资源管理、Pod调度、弹性伸缩、安全控制、系统监控和纠错等管理能力，并且都是全自动完成的。Node作为集群中的工作节点，运行真正的应用程序，在Node上Kubernetes管理的最小运行单元是Pod。Node上运行着Kubernetes的kubelet、kube-proxy服务进程，这些服务进程负责Pod的创建、启动、监控、重启、销毁以及实现软件模式的负载均衡器。  
  
在Kubernetes集群中，它解决了传统IT系统中服务扩容和升级的两大难题。如果今天的软件并不是特别复杂并且需要承载的峰值流量不是特别多，那么后端项目的部署其实也只需要在虚拟机上安装一些简单的依赖，将需要部署的项目编译后运行就可以了。但是随着软件变得越来越复杂，一个完整的后端服务不再是单体服务，而是由多个职责和功能不同的服务组成，服务之间复杂的拓扑关系以及单机已经无法满足的性能需求使得软件的部署和运维工作变得非常复杂，这也就使得部署和运维大型集群变成了非常迫切的需求。  
  
Kubernetes 的出现不仅主宰了容器编排的市场，更改变了过去的运维方式，不仅将开发与运维之间边界变得更加模糊，而且让 DevOps 这一角色变得更加清晰，每一个软件工程师都可以通过 Kubernetes 来定义服务之间的拓扑关系、线上的节点个数、资源使用量并且能够快速实现水平扩容、蓝绿部署等在过去复杂的运维操作。

### 三、kubernetes 功能

### 1.概述

Kubernetes 是一个轻便的和可扩展的开源平台，用于管理容器化应用和服务。通过Kubernetes 能够进行应用的自动化部署和扩缩容。在 Kubernetes 中，会将组成应用的容器组合成一个逻辑单元以更易管理和发现。Kubernetes 积累了作为 Google 生产环境运行工作负载 15 年的经验，并吸收了来自于社区的最佳想法和实践。

### 2.功能

#### 1.自动装箱  
基于容器对应用运行环境的资源配置要求自动部署应用容器  
  
#### 2.自我修复(自愈能力)  
当容器失败时，会对容器进行重启  
当所部署的 Node 节点有问题时，会对容器进行重新部署和重新调度  
当容器未通过监控检查时，会关闭此容器直到容器正常运行时，才会对外提供服务  
  
#### 3.水平扩展  
通过简单的命令、用户 UI 界面或基于 CPU 等资源使用情况，对应用容器进行规模扩大或规模剪裁  
  
#### 4.服务发现  
用户不需使用额外的服务发现机制，就能够基于 Kubernetes 自身能力实现服务发现和负载均衡  
  
#### 5.滚动更新  
可以根据应用的变化，对应用容器运行的应用，进行一次性或批量式更新  
  
#### 6.版本回退  
可以根据应用部署情况，对应用容器运行的应用，进行历史版本即时回退  
  
#### 7.密钥和配置管理  
在不需要重新构建镜像的情况下，可以部署和更新密钥和应用配置，类似热部署。  
  
#### 8.存储编排  
自动实现存储系统挂载及应用，特别对有状态应用实现数据持久化非常重要  
存储系统可以来自于本地目录、网络存储(NFS、Gluster、Ceph 等)、公共云存储服务  
  
#### 9.批处理  
提供一次性任务，定时任务；满足批量数据处理和分析的场景

### 四、Kubernetes集群架构

Kubernetes 遵循非常传统的客户端服务端架构，客户端通过 RESTful 接口或者直接使用 kubectl 与 Kubernetes 集群进行通信，这两者在实际上并没有太多的区别，后者也只是对 Kubernetes 提供的 RESTful API 进行封装并提供出来。每一个 Kubernetes 集群都由一组 Master 节点和一系列的 Worker 节点组成，其中 Master 节点主要负责存储集群的状态并为 Kubernetes 对象分配和调度资源。

#### 1.Master

它主要负责接收客户端的请求，安排容器的执行并且运行控制循环，将集群的状态向目标状态进行迁移，Master 节点内部由三个组件构成:  
  
##### 1. API Server  
负责处理来自用户的请求，其主要作用就是对外提供 RESTful 的接口，包括用于查看集群状态的读请求以及改变集群状态的写请求，也是唯一一个与 etcd 集群通信的组件。  
  
##### 2. ControllerController  
管理器运行了一系列的控制器进程，这些进程会按照用户的期望状态在后台不断地调节整个集群中的对象，当服务的状态发生了改变，控制器就会发现这个改变并且开始向目标状态迁移。  
  
##### 3. SchedulerScheduler  
调度器其实为 Kubernetes 中运行的 Pod 选择部署的 Worker 节点，它会根据用户的需要选择最能满足请求的节点来运行 Pod，它会在每次需要调度 Pod 时执行。

### 2. Node

Node节点实现相对简单一点，主要是由kubelet和kube-proxy两部分组成： kubelet 是一个节点上的主要服务，它周期性地从 API Server 接受新的或者修改的 Pod 规范并且保证节点上的 Pod 和其中容器的正常运行，还会保证节点会向目标状态迁移，该节点仍然会向 Master 节点发送宿主机的健康状况。 kube-proxy 负责宿主机的子网管理，同时也能将服务暴露给外部，其原理就是在多个隔离的网络中把请求转发给正确的 Pod 或者容器。

### 3.kubernetes结构图

在这张系统架构图中，我们把服务分为运行在工作节点上的服务和组成集群级别控制板的服务。  
  
Kubernetes主要由以下几个核心组件组成：  
1. etcd保存了整个集群的状态  
2. apiserver提供了资源操作的唯一入口，并提供认证、授权、访问控制、API注册和发现等机制  
3. controller manager负责维护集群的状态，比如故障检测、自动扩展、滚动更新等  
4. scheduler负责资源的调度，按照预定的调度策略将Pod调度到相应的机器上  
5. kubelet负责维护容器的生命周期，同时也负责Volume（CVI）和网络（CNI）的管理  
6. Container runtime负责镜像管理以及Pod和容器的真正运行（CRI）  
7. kube-proxy负责为Service提供cluster内部的服务发现和负载均衡  
  
除了核心组件，还有一些推荐的组件：  
1．kube-dns负责为整个集群提供DNS服务  
2．Ingress Controller为服务提供外网入口  
3．Heapster提供资源监控  
4．Dashboard提供GUI  
5. Federation提供跨可用区的集群  
6．Fluentd-elasticsearch提供集群日志采集、存储与查询

### 五、kubernetes核心概念简述

### 1.Pod

Kubernetes使用Pod来管理容器，每个Pod可以包含一个或多个紧密关联的容器。  
  
Pod是一组紧密关联的容器集合，它们共享PID、IPC、Network 和UTS namespace，是Kubernetes调度的基本单位。Pod内的多个容器共享网络和文件系统，可以通过进程间通信和文件共享这种简单高效的方式组合完成服务。#深度好文计划#

在 Kubernetes 中，所有对象都使用 manifest（yaml 或 json）来定义，比如一个简单的nginx 服务可以定义为 nginx.yaml，它包含一个镜像为 nginx 的容器：

apiVersion: v1  
kind: Pod  
metadata:  
name: nginx  
labels:  
app: nginx  
spec:  
containers:  
- name: nginx  
image: nginx  
ports:  
- containerPort: 80

### 2.controller-manager

#1.确保预期的pod副本数量  
  
#2.无状态应用部署/有状态应用部署  
  
#3.确保所有的node运行同一个pod  
  
#4.—次性任务和定时任务

### 3.service

#1.定义一组pod的访问规则

### 六、Kubernetes部署方式

Kubernetes有两种方式，第一种是二进制的方式，可定制但是部署复杂容易出错；第二种是kubeadm工具安装，部署简单，不可定制化。本次我们部署kubeadm版。

### 1.kubeadm工具安装

#1.kubeadm工具安装，部署简单，不可定制化  
Kubeadm 是一个 K8s 部署工具，提供 kubeadm init 和 kubeadm join，用于快速部署 Kubernetes 集群。  
官方地址：https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/

### 2.二进制包的方式

#2.二进制包的方式，可定制但是部署复杂容易出错  
从 github 下载发行版的二进制包，手动部署每个组件，组成 Kubernetes 集群。  
Kubeadm 降低部署门槛，但屏蔽了很多细节，遇到问题很难排查。如果想更容易可控，推荐使用二进制包部署 Kubernetes 集群，虽然手动部署麻烦点，期间可以学习很多工作原理，也利于后期维护。

### 七、软硬件以及系统的要求

#1.CPU和内存  
Master：至少2core和4GB内存  
Node：至少4core和16GB内存  
  
#2.kernel版本  
kernel版本要求至少在3.10及以上  
  
#3.etcd  
etcd 3.0版本及以上  
  
#4.Docker  
docker 18.03及以上